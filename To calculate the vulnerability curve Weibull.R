#### Authors: Daniel Nadal-Sala

#### Description

#This script analyzes the vulnerability curves and provides an average vulnerability curve response.
#It assumes a Weibull distribution.

#### Libraries

library(BayesianTools);library(ggplot2)

#### Functions

#### Data path
Directory<-"C:/Users/sala-d/Desktop/Accounting for NonStomatal Limitations/Data/"

#### Data Files

Data<- read.table(file=paste(Directory,"VulnerabilityCurves.csv",sep=""),
                   header=T,sep=";",dec=".")

#################################################

#### Data processing

NSamples<-length(levels(as.factor(Data$Sample)))

#Preparing the prior
ParamNames<-c("Psi50","A_coef", "SD")
Upper<-c(-1.5, 8,   1) 
Lower<-c(-3.5, 1, 0.1)

prior <- createUniformPrior(lower = Lower, upper = Upper)

#Preparing the likelihood
likelihood<-function(param){
  
  par1<-param[1]
  par2<-param[2]
  SD <- param[3]
  
  #Predicted<-(100-(1/(1+(Psi/par1)^par2))*100)
  
  Predicted<-(1-exp(-(Psi/par1)^par2))*100
  
  LLikelihood<-sum(dnorm(Predicted,mean=PLC_ref,sd=SD,log=T))
  
  return(LLikelihood)
  
}

Setup = createBayesianSetup(likelihood=likelihood, prior = prior, names=ParamNames)

settings = list(iterations = 50000)

##############################

#### Data analysis

# Here we will run a bayesian calibration for each sample, and the we will use 1000 random samples from the posterior to predict

Posterior<-list()

MergedPosterior<-NULL

for (i in 1:NSamples){
  
  DataSample<-Data[which(Data$Sample==i),]
  Psi<-DataSample$pressure
  PLC_ref<-DataSample$PLC
  
  set.seed(13) #We homogenize the seed for all the calibrations
  
  CalibrationVulnerability <- runMCMC(bayesianSetup = Setup, sampler = "DEzs", settings = settings)
  
  SamplePosterior<-CalibrationVulnerability$Z[30000:50000,]
  
  Posterior[[i]]<-SamplePosterior
  
  SampleP<-sample(nrow(SamplePosterior),size = 1000,replace=TRUE)
  
  SampleP<-SamplePosterior[SampleP,]
  
  MergedPosterior<-rbind(MergedPosterior,SampleP)
  
}

#To predict with the merged posterior

Psi<-seq(0,-6,-0.2)

Pred<-NULL

NReplicates<-1000

set.seed(13)

for(i in 1:NReplicates){
  
  ParamSample<-MergedPosterior[sample(nrow(MergedPosterior),size = 1),]
  
  PLC<-(1-exp(-(Psi/ParamSample[1])^ParamSample[2]))*100
  
  Pred<-rbind(Pred,PLC)
  
}

SD<-NULL
Median<-NULL

for(i in 1:length(Pred[1,])){
  SD[i]<-sd(Pred[,i])
  Median[i]<-median(Pred[,i])
}

DataFrame<-data.frame(Psi=Psi,Median=Median,SD=SD)
Data$Sample<-as.factor(Data$Sample)
##############################

#### Plots

#To plot the percent loss of water conductance

MedianPsi50<-median(MergedPosterior[,1])
CIPsi50<-quantile(MergedPosterior[,1],probs = c(0.025,0.975))

psi50<-NULL
PLCpred<-seq(-0.1,-5,-0.01)
NReplicates<-1000

set.seed(13)

#To obtain psi50
for(i in 1:NReplicates){
  
  ParamSample<-MergedPosterior[sample(nrow(MergedPosterior),size = 1),]
  PLCtoPsi50<-(1-exp(-(PLCpred/ParamSample[1])^ParamSample[2]))*100
  
  psi50_temp<-PLCpred[which(abs(PLCtoPsi50-50)==min(abs(PLCtoPsi50-50)))][1]
  
  psi50<-rbind(psi50,psi50_temp)}

QuantilesPsi50<-quantile(psi50,prob=c(0.025,0.5,0.975))

#### To plot the results:

ggplot(Data)+
  theme_bw(30)+
  scale_color_manual(values=c(rep("black",5)))+
  geom_line(aes(x=-pressure,y=PLC,color=Sample),alpha=0.5)+
  geom_vline(aes(xintercept=-QuantilesPsi50[2]))+
  geom_vline(aes(xintercept=-QuantilesPsi50[1]),linetype = "dashed")+
  geom_vline(aes(xintercept=-QuantilesPsi50[3]),linetype = "dashed")+
  geom_ribbon(data=DataFrame, aes(x=-Psi,ymin=(Median-SD), ymax=Median+SD),fill="steelblue",alpha=0.3)+
  geom_line(data=DataFrame,aes(x=-Psi,y=Median),size=2,color="steelblue")+
  labs(y = expression(Percent~loss~conductivity~('%')),
       x = expression(Xylem~water~potential~('-'~MPa)),family="sans")+
  theme(axis.text.x = element_text(hjust = 1, size=20,color="black",family="sans"))+
  theme(axis.text.y = element_text(hjust = 1, size=20,color="black",family="sans"))+
  theme(axis.title.x = element_text ( size=20,color="black",family="sans"),
        axis.title.y = element_text ( size=20,color="black",family="sans"))+
  theme(legend.position="none")

#################################################

# To calculate the pseudo-R2

RMSE<-NULL
pseudoR2<-NULL

NReplicates<-1000

set.seed(13)

for(i in 1:NReplicates){
  
  ParamSample<-MergedPosterior[sample(nrow(MergedPosterior),size = 1),]
  
  PLC<-(1-exp(-(Data$pressure/ParamSample[1])^ParamSample[2]))*100
  
  pR2<-mean(cor(PLC,Data$PLC)^2)
  RMSErow<-mean(sqrt((Data$PLC-PLC)^2))

  pseudoR2<-rbind(pseudoR2,pR2)
  RMSE<-rbind(RMSE,RMSErow)
  
}

mean(RMSE)
mean(pseudoR2)

# pseudo-R2 = 0.91
# RMSE = 8.7

#Here there are the median and the 95%CI for the reference water potential.
median(MergedPosterior[,1])
quantile(MergedPosterior[,1],probs=c(0.025,0.975))

#Here there are the median and the 95%CI for the tuning parameter.
median(MergedPosterior[,2])
quantile(MergedPosterior[,2],probs=c(0.025,0.975))
